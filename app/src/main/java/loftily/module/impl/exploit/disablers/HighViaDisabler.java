package loftily.module.impl.exploit.disablers;

import loftily.event.impl.packet.PacketReceiveEvent;
import loftily.event.impl.packet.PacketSendEvent;
import loftily.event.impl.world.PreUpdateEvent;
import loftily.module.impl.exploit.Disabler;
import loftily.utils.client.PacketUtils;
import loftily.value.impl.BooleanValue;
import loftily.value.impl.NumberValue;
import loftily.value.impl.mode.Mode;
import net.lenni0451.lambdaevents.EventHandler;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.CPacketPlayer;
import net.minecraft.network.play.server.SPacketPlayerPosLook;

import java.util.LinkedList;
import java.util.Queue;

public class HighViaDisabler extends Mode<Disabler> {
    public HighViaDisabler() {
        super("HighVia");
    }

    private final NumberValue packets = new NumberValue("HighVia-OffsetPackets",1,0,10);
    private final NumberValue yPackets = new NumberValue("HighVia-InvalidYPackets",1,0,10);
    private final NumberValue teleportSpeed = new NumberValue("HighVia-TeleportSpeed",11,0,999);
    private final BooleanValue disabled = new BooleanValue("HighVia-C06ToC04",false);

    public final Queue<Packet<?>> packetBus = new LinkedList<>();

    @EventHandler
    public void onReceivePacket(PacketReceiveEvent event) {
        Packet<?> packet = event.getPacket();
        if(packet instanceof SPacketPlayerPosLook) {
            event.setCancelled(true);
            packetBus.add(packet);
        }
    }

    @EventHandler
    public void onPacketSend(PacketSendEvent event) {
        Packet<?> packet = event.getPacket();
        if (packet instanceof CPacketPlayer.PositionRotation && disabled.getValue()) {
            event.setCancelled(true);
            PacketUtils.sendPacket(new CPacketPlayer.Position(((CPacketPlayer.PositionRotation) packet).x,
                    ((CPacketPlayer.PositionRotation) packet).y,
                    ((CPacketPlayer.PositionRotation) packet).z,
                    ((CPacketPlayer.PositionRotation) packet).onGround));
        }
    }

    @EventHandler
    public void onPreUpdate(PreUpdateEvent event) {
        for (int i = 0; i < yPackets.getValue(); i++) {
            PacketUtils.sendPacket(new CPacketPlayer.PositionRotation(
                    mc.player.posX + 999,
                    mc.player.posY - 6969,
                    mc.player.posZ + 999,
                    mc.player.rotationYaw,
                    mc.player.rotationPitch,true
            ));
        }
        for (int i = 0; i < packets.getValue(); i++) {
            PacketUtils.sendPacket(new CPacketPlayer.PositionRotation(
                    mc.player.posX + 999,
                    mc.player.posY + (mc.gameSettings.keyBindJump.isKeyDown() ? 1.5624 : 0.00000001) - (mc.gameSettings.keyBindSneak.isKeyDown() ? 0.0624 : 0.00000002),
                    mc.player.posZ + 999,
                    mc.player.rotationYaw,
                    mc.player.rotationPitch,true
            ));
        }

        if(teleportSpeed.getValue() != 0) {
            mc.player.setPosition(
                    mc.player.posX + mc.player.motionX * teleportSpeed.getValue(),
                    mc.player.posY,
                    mc.player.posZ + mc.player.motionZ * teleportSpeed.getValue()
            );
        }
    }

    @Override
    public void onDisable() {
        if(!packetBus.isEmpty()) {
            for (Packet<?> packet : packetBus) {
                PacketUtils.receivePacket(packet, false);
            }
            packetBus.clear();
        }
    }
}
